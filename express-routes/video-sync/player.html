<!DOCTYPE html>
<html>
	<head>
		<title>[room_name] - video sync</title>
		<style type="text/css">
			* {
				margin: 0;
				padding: 0;
			}

			html, body {
				overflow: hidden;
				background: #000;
			}

			video {
				width: 100vw;
				height: 100vh;
			}

			canvas {
				position: fixed; margin: auto;
				top: 0; left: 0;
				width: 256px;
				height: 256px;
				image-rendering: pixelated;
			}

			h2 {
				position: fixed; margin: auto;
				top: 256px; left: 0;
				image-rendering: pixelated;
				text-shadow: 0 0 32px #000;
				color: #fff;
			}
		</style>
	</head>
	<body>
		<video></video>
		<script src="socket.io.js"></script>
		<script type="text/javascript">
			var _GET = {};
			window.location.search.substr(1).split("&").forEach(function(e, i) {
				if (e=="") return;
				let param = e.split("=");
				_GET[param[0]] = param[1];
			});

			var socket = io("[namespace]");
			var video = document.querySelector("video");

			let actualPosition = 0;
			setInterval(()=>{
				if (!video.paused) actualPosition++;
				if (Math.abs(video.currentTime-actualPosition)>2) { // seconds
					console.log("out of sync");
					socket.emit("getInfo");
				}
			}, 1000);

			socket.on("getInfo", info=>{
				console.log(info);
				actualPosition = info.position;

				if (video.src != info.src) video.src = info.src;
				if (video.playing != info.playing) {
					if (info.playing) {
						video.play();
					} else {
						video.pause();
					}
				} 

				video.currentTime = info.position;
				video.volume = info.volume;
			});
			socket.emit("getInfo");

			if (_GET.dynamicLights) {
				let canvas = document.createElement("canvas");
				canvas.width = canvas.height = 3;
				//document.body.appendChild(canvas);

				//let debug = document.createElement("h2");
				//document.body.appendChild(debug);

				let ctx = canvas.getContext("2d");

				function getColors() {
					let colors = new Array();
					[
						ctx.getImageData(0,0,1,1).data,
						ctx.getImageData(1,0,1,1).data,
						ctx.getImageData(2,0,1,1).data,

						ctx.getImageData(0,1,1,1).data,
						ctx.getImageData(2,1,1,1).data,

						ctx.getImageData(0,2,1,1).data,
						ctx.getImageData(1,2,1,1).data,
						ctx.getImageData(2,2,1,1).data,
					].forEach(c=>{
						colors = colors.concat([c[0],c[1],c[2]]);
					});
					//debug.textContent = colors.join(",");
					return colors.join(",");
				}

				let renderWidth = 3;
				if (_GET["3D"])renderWidth = 6;

				if (window.qt) setInterval(()=>{
					ctx.drawImage(video, 0, 0, renderWidth, 3);
					EventBridge.emitWebEvent(getColors());
				}, 1000/30);
			}
		</script>
	</body>
</html>